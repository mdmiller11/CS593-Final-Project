*Import Dataset;
PROC IMPORT DATAFILE="C:\Local\DATA1.csv"
     OUT=work.DATA1z
     DBMS=CSV;
RUN;

*Define Variable List;
%let num_Var = NUMBRANCH -- FAMINC_IND DEBT_MDN_SUPP GRAD_DEBT_MDN_SUPP;
%let cat_Var = SCH_DEG_1_0 -- ICLEVEL_3;





/*--------------------------------------------------------------------------------------------------------------------------------------------------*/
*Check LR Assumptions;
*Reference:
    - https://www.listendata.com/2015/03/checking-assumptions-of-regression.html
    - https://stats.idre.ucla.edu/sas/dae/robust-regression/
    - https://www.listendata.com/2015/08/checking-homoscedasticity-with-sas.html
    - https://www.statisticssolutions.com/assumptions-of-multiple-linear-regression/;
*1.Outliers;
PROC REG DATA=DATA1z;
    MODEL MD_EARN_WNE_P10 = &num_Var &cat_Var / STB CLB;
    OUTPUT OUT=stdres P=predict STUDENT=res R=resid RSTUDENT=r H=lev COOKD=cookd DFFITS=dffit;
RUN;
QUIT;
*Leverage - Residual Squared plot;
DATA stdres; SET stdres;
    resid_sq = res*res;
RUN;
PROC SGPLOT DATA=stdres;
    SCATTER Y=lev X=resid_sq / DATALABEL=VAR1;
RUN;
QUIT;
*Print data with large Cook's Distance;
PROC PRINT DATA=stdres;
    WHERE cookd > (4/6062);
    VAR cookd MD_EARN_WNE_P10 &num_Var &cat_Var;
RUN;
*Remove rows with large Cook's Distance;
DATA DATA2z; SET stdres;
    IF cookd > (4/6062) THEN DELETE;
RUN;
DATA DATA2z; SET DATA2z (KEEP = VAR1 -- ICLEVEL_3);
RUN;

*2.Linear relationships;
ODS GRAPHICS ON;
PROC REG DATA=DATA2z PLOTS(MAXPOINTS=NONE);
    MODEL MD_EARN_WNE_P10 = &num_Var &cat_Var / PARTIAL;
RUN;
QUIT;
ODS GRAPHICS OFF;
PROC CORR DATA=DATA2z;
    VAR &num_Var &cat_Var;
    WITH MD_EARN_WNE_P10;
RUN;

%LET xlist = NUMBRANCH TUITFTE INEXPFTE COMP_ORIG_YR2_RT WDRAW_ORIG_YR2_RT LO_INC_COMP_ORIG_YR2_RT LO_INC_WDRAW_ORIG_YR2_RT DEP_COMP_ORIG_YR2_RT IND_COMP_ORIG_YR2_RT FIRSTGEN_COMP_ORIG_YR2_RT FIRSTGEN_WDRAW_ORIG_YR2_RT NOT1STGEN_COMP_ORIG_YR2_RT NOT1STGEN_WDRAW_ORIG_YR2_RT WDRAW_ORIG_YR3_RT WDRAW_4YR_TRANS_YR3_RT LO_INC_COMP_ORIG_YR3_RT LO_INC_WDRAW_ORIG_YR3_RT DEP_COMP_ORIG_YR3_RT IND_COMP_ORIG_YR3_RT FEMALE_COMP_ORIG_YR3_RT MALE_COMP_ORIG_YR3_RT FIRSTGEN_COMP_ORIG_YR3_RT FIRSTGEN_WDRAW_ORIG_YR3_RT NOT1STGEN_WDRAW_ORIG_YR3_RT COMP_ORIG_YR4_RT WDRAW_ORIG_YR4_RT WDRAW_2YR_TRANS_YR4_RT LO_INC_COMP_ORIG_YR4_RT DEP_COMP_ORIG_YR4_RT IND_COMP_ORIG_YR4_RT FEMALE_COMP_ORIG_YR4_RT MALE_COMP_ORIG_YR4_RT FIRSTGEN_COMP_ORIG_YR4_RT NOT1STGEN_COMP_ORIG_YR4_RT NOT1STGEN_WDRAW_ORIG_YR4_RT INC_PCT_LO DEP_STAT_PCT_IND DEP_INC_PCT_LO IND_INC_PCT_LO PAR_ED_PCT_1STGEN INC_PCT_M1 INC_PCT_M2 INC_PCT_H1 INC_PCT_H2 PAR_ED_PCT_MS PAR_ED_PCT_HS PAR_ED_PCT_PS APPL_SCH_PCT_GE2 APPL_SCH_PCT_GE3 APPL_SCH_PCT_GE4 APPL_SCH_PCT_GE5 DEP_INC_AVG IND_INC_AVG OVERALL_YR2_N LO_INC_YR2_N MD_INC_YR2_N HI_INC_YR2_N DEP_YR2_N IND_YR2_N FEMALE_YR2_N MALE_YR2_N PELL_YR2_N NOPELL_YR2_N LOAN_YR2_N NOLOAN_YR2_N FIRSTGEN_YR2_N NOT1STGEN_YR2_N OVERALL_YR3_N LO_INC_YR3_N MD_INC_YR3_N HI_INC_YR3_N DEP_YR3_N IND_YR3_N FEMALE_YR3_N MALE_YR3_N PELL_YR3_N 
             NOPELL_YR3_N LOAN_YR3_N NOLOAN_YR3_N FIRSTGEN_YR3_N NOT1STGEN_YR3_N OVERALL_YR4_N LO_INC_YR4_N MD_INC_YR4_N HI_INC_YR4_N DEP_YR4_N IND_YR4_N FEMALE_YR4_N MALE_YR4_N PELL_YR4_N NOPELL_YR4_N LOAN_YR4_N NOLOAN_YR4_N FIRSTGEN_YR4_N NOT1STGEN_YR4_N DEBT_MDN GRAD_DEBT_MDN WDRAW_DEBT_MDN LO_INC_DEBT_MDN MD_INC_DEBT_MDN HI_INC_DEBT_MDN DEP_DEBT_MDN IND_DEBT_MDN PELL_DEBT_MDN NOPELL_DEBT_MDN FEMALE_DEBT_MDN MALE_DEBT_MDN FIRSTGEN_DEBT_MDN NOTFIRSTGEN_DEBT_MDN DEBT_N GRAD_DEBT_N WDRAW_DEBT_N LO_INC_DEBT_N MD_INC_DEBT_N HI_INC_DEBT_N DEP_DEBT_N IND_DEBT_N PELL_DEBT_N NOPELL_DEBT_N FEMALE_DEBT_N MALE_DEBT_N FIRSTGEN_DEBT_N NOTFIRSTGEN_DEBT_N CUML_DEBT_N CUML_DEBT_P90 CUML_DEBT_P75 CUML_DEBT_P25 CUML_DEBT_P10 INC_N DEP_INC_N IND_INC_N DEP_STAT_N PAR_ED_N APPL_SCH_N SEPAR_DT_N LOAN_EVER PELL_EVER AGE_ENTRY FEMALE MARRIED DEPENDENT FIRST_GEN FAMINC MD_FAMINC FAMINC_IND DEBT_MDN_SUPP GRAD_DEBT_MDN_SUPP SCH_DEG_1_0 SCH_DEG_2_0 SCH_DEG_3_0 MAIN_0 MAIN_1 PREDDEG_1 PREDDEG_2 PREDDEG_3 PREDDEG_4 HIGHDEG_1 HIGHDEG_2 HIGHDEG_3 HIGHDEG_4 CONTROL_1 CONTROL_2 CONTROL_3 ST_FIPS_5 ST_FIPS_6 ST_FIPS_9 ST_FIPS_11 ST_FIPS_12 ST_FIPS_16 ST_FIPS_21 ST_FIPS_22 ST_FIPS_24 ST_FIPS_25 ST_FIPS_26 ST_FIPS_27 ST_FIPS_28 ST_FIPS_36 ST_FIPS_40 ST_FIPS_42 ST_FIPS_44 ST_FIPS_47 ST_FIPS_48 ST_FIPS_50 ST_FIPS_51 ST_FIPS_53 ST_FIPS_54 ST_FIPS_55 ST_FIPS_72 REGION_0 REGION_1 REGION_2 REGION_4 REGION_5 REGION_6 REGION_7
             REGION_8 REGION_9 CIP01CERT1_0_0 CIP01CERT1_1_0 CIP01CERT2_1_0 CIP01BACHL_0_0 CIP01BACHL_1_0 CIP01BACHL_2_0 CIP03ASSOC_1_0 CIP03BACHL_0_0 CIP03BACHL_1_0 CIP03BACHL_2_0 CIP04BACHL_0_0 CIP04BACHL_1_0 CIP05CERT1_1_0 CIP05ASSOC_1_0 CIP05CERT4_1_0 CIP05BACHL_0_0 CIP05BACHL_1_0 CIP05BACHL_2_0 CIP09CERT1_0_0 CIP09CERT1_1_0 CIP09CERT1_2_0 CIP09CERT4_1_0 CIP09BACHL_0_0 CIP09BACHL_1_0 CIP09BACHL_2_0 CIP10CERT1_1_0 CIP10BACHL_0_0 CIP10BACHL_1_0 CIP11CERT1_0_0 CIP11CERT1_1_0 CIP11CERT2_0_0 CIP11CERT2_1_0 CIP11ASSOC_0_0 CIP11ASSOC_1_0 CIP11BACHL_0_0 CIP11BACHL_1_0 CIP11BACHL_2_0 CIP12CERT1_0_0 CIP12CERT1_1_0 CIP12CERT2_0_0 CIP12CERT2_1_0 CIP12ASSOC_0_0 CIP12ASSOC_1_0 CIP12CERT4_0_0 CIP12CERT4_1_0 CIP12BACHL_1_0 CIP13CERT2_1_0 CIP13ASSOC_0_0 CIP13ASSOC_1_0 CIP13CERT4_1_0 CIP13BACHL_0_0 CIP13BACHL_1_0 CIP13BACHL_2_0 CIP14CERT4_1_0 CIP14BACHL_0_0 CIP14BACHL_1_0 CIP14BACHL_2_0 CIP15CERT1_0_0 CIP15CERT1_1_0 CIP15CERT2_0_0 CIP15CERT2_1_0 CIP15CERT2_2_0 CIP15BACHL_0_0 CIP15BACHL_1_0 CIP15BACHL_2_0 CIP16BACHL_0_0 CIP16BACHL_1_0 CIP16BACHL_2_0 CIP19CERT1_0_0 CIP19CERT1_1_0 CIP19CERT1_2_0 CIP19CERT2_0_0 CIP19CERT2_1_0 CIP19ASSOC_0_0 CIP19ASSOC_1_0 CIP19BACHL_0_0 CIP19BACHL_1_0 CIP19BACHL_2_0 CIP22CERT2_1_0 CIP22ASSOC_0_0 CIP22ASSOC_1_0 CIP22BACHL_0_0 CIP22BACHL_1_0 CIP23CERT1_1_0 CIP23BACHL_0_0 CIP23BACHL_1_0 CIP23BACHL_2_0 CIP24CERT2_0_0 CIP24CERT2_1_0 CIP24CERT2_2_0 CIP24ASSOC_0_0 CIP24ASSOC_1_0 
             CIP24BACHL_0_0 CIP24BACHL_1_0 CIP24BACHL_2_0 CIP25BACHL_1_0 CIP26BACHL_0_0 CIP26BACHL_1_0 CIP27CERT1_1_0 CIP27CERT4_1_0 CIP27BACHL_0_0 CIP27BACHL_1_0 CIP27BACHL_2_0 CIP29CERT1_2_0 CIP29ASSOC_2_0 CIP29BACHL_2_0 CIP30CERT1_0_0 CIP30CERT1_1_0 CIP30CERT1_2_0 CIP30CERT4_1_0 CIP30BACHL_0_0 CIP30BACHL_1_0 CIP30BACHL_2_0 CIP31CERT2_1_0 CIP31BACHL_0_0 CIP31BACHL_1_0 CIP31BACHL_2_0 CIP38CERT1_1_0 CIP38BACHL_0_0 CIP38BACHL_1_0 CIP38BACHL_2_0 CIP39CERT1_1_0 CIP39BACHL_0_0 CIP39BACHL_1_0 CIP39BACHL_2_0 CIP40CERT1_1_0 CIP40BACHL_0_0 CIP40BACHL_1_0 CIP40BACHL_2_0 CIP41BACHL_1_0 CIP42CERT1_1_0 CIP42CERT4_1_0 CIP42BACHL_0_0 CIP42BACHL_1_0 CIP42BACHL_2_0 CIP43CERT1_0_0 CIP43CERT1_1_0 CIP43CERT2_0_0 CIP43CERT2_1_0 CIP43CERT2_2_0 CIP43ASSOC_0_0 CIP43ASSOC_1_0 CIP43BACHL_0_0 CIP43BACHL_1_0 CIP43BACHL_2_0 CIP44BACHL_0_0 CIP44BACHL_1_0 CIP44BACHL_2_0 CIP45CERT1_0_0 CIP45CERT1_1_0 CIP45ASSOC_2_0 CIP45BACHL_0_0 CIP45BACHL_1_0 CIP45BACHL_2_0 CIP46CERT1_0_0 CIP46CERT1_1_0 CIP46CERT2_0_0 CIP46CERT2_1_0 CIP46ASSOC_1_0 CIP46BACHL_2_0 CIP47CERT1_0_0 CIP47CERT1_1_0 CIP47CERT2_0_0 CIP47CERT2_1_0 CIP47ASSOC_0_0 CIP47ASSOC_1_0 CIP47BACHL_1_0 CIP48CERT1_0_0 CIP48CERT1_1_0 CIP48CERT2_0_0 CIP48CERT2_1_0 CIP48ASSOC_0_0 CIP48ASSOC_1_0 CIP49CERT1_0_0 CIP49CERT1_1_0 CIP49BACHL_0_0 CIP49BACHL_1_0 CIP49BACHL_2_0 CIP50BACHL_0_0 CIP50BACHL_1_0 CIP50BACHL_2_0 CIP51CERT1_0_0 CIP51CERT1_1_0 CIP51CERT2_0_0 CIP51CERT2_1_0
             CIP51CERT2_2_0 CIP51ASSOC_0_0 CIP51ASSOC_1_0 CIP51CERT4_0_0 CIP51CERT4_1_0 CIP51BACHL_0_0 CIP51BACHL_1_0 CIP51BACHL_2_0 CIP52CERT1_1_0 CIP52CERT2_0_0 CIP52CERT2_1_0 CIP52CERT2_2_0 CIP52ASSOC_0_0 CIP52ASSOC_1_0 CIP52BACHL_0_0 CIP52BACHL_1_0 CIP52BACHL_2_0 CIP54CERT2_1_0 CIP54BACHL_0_0 CIP54BACHL_1_0 CIP54BACHL_2_0 DISTANCEONLY_1_0 ICLEVEL_1 ICLEVEL_2 ICLEVEL_3;

DATA DATA2z; SET DATA2z (KEEP = MD_EARN_WNE_P10 &xlist);
RUN;

*3.Normally distributed residuals;
PROC UNIVARIATE DATA=DATA2z;
    VAR MD_EARN_WNE_P10;
    HISTOGRAM;
    QQPLOT;
RUN;
PROC UNIVARIATE DATA=stdres NORMAL;
    VAR resid;
RUN;

*4.Homoscedasticity;
PROC REG DATA=DATA2z PLOTS(MAXPOINTS=NONE);
    MODEL MD_EARN_WNE_P10 = &xlist;
    PLOT R.*P.;
RUN;
QUIT;

*5.Multicollinearity & Autocorrelation;
PROC REG DATA=DATA2z;
    MODEL MD_EARN_WNE_P10 = &xlist / VIF DW;
RUN;
QUIT;





/*--------------------------------------------------------------------------------------------------------------------------------------------------*/
*Simple Linear Regression;
PROC REG DATA=DATA2z PLOTS(MAXPOINTS=NONE);
    MODEL MD_EARN_WNE_P10 = &xlist
               / SELECTION=NONE;
    OUTPUT OUT=REG_DATA2zOUT_01
    H=lev COOKD=Cookd DFFITS=dffit;
RUN;
QUIT;

*SELECTION = Forward;
PROC REG DATA=DATA2z;
    MODEL MD_EARN_WNE_P10 = &xlist
               / SELECTION=FORWARD;
    OUTPUT OUT=REG_DATA2zOUT_1
    H=lev COOKD=Cookd DFFITS=dffit;
RUN;
QUIT;

*SELECTION = Stepwise;
PROC REG DATA=DATA2z;
    MODEL MD_EARN_WNE_P10 = &xlist
               / SELECTION=STEPWISE;
    OUTPUT OUT=REG_DATA2zOUT_2
    H=lev COOKD=Cookd DFFITS=dffit;
RUN;
QUIT;





/*--------------------------------------------------------------------------------------------------------------------------------------------------*/
*PCA;
PROC PRINCOMP DATA=DATA2z OUT=PCA_DATA2z; * N=25;
    VAR &xlist;
RUN;

*Simple Linear Regression with PCA;
PROC REG DATA=PCA_DATA2z;
    MODEL MD_EARN_WNE_P10 = Prin1 -- Prin18;
    OUTPUT OUT=REG_PCA_DATA2z_OUT;
QUIT;
